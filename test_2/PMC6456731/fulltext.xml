<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN" "JATS-archivearticle1.dtd"> 
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" article-type="research-article"><?properties open_access?><?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?><?DTDIdentifier.IdentifierType public?><?SourceDTD.DTDName A++V2.4.dtd?><?SourceDTD.Version 2.4?><?ConverterInfo.XSLTName springer2nlmx2.xsl?><?ConverterInfo.Version 1?><front><journal-meta><journal-id journal-id-type="nlm-ta">Nat Commun</journal-id><journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id><journal-title-group><journal-title>Nature Communications</journal-title></journal-title-group><issn pub-type="epub">2041-1723</issn><publisher><publisher-name>Nature Publishing Group UK</publisher-name><publisher-loc>London</publisher-loc></publisher></journal-meta><article-meta><article-id pub-id-type="pmcid">6456731</article-id><article-id pub-id-type="publisher-id">9639</article-id><article-id pub-id-type="doi">10.1038/s41467-019-09639-3</article-id><article-categories><subj-group subj-group-type="heading"><subject>Article</subject></subj-group></article-categories><title-group><article-title>A Bayesian mixture model for clustering droplet-based single-cell transcriptomic data from population studies</article-title></title-group><contrib-group><contrib contrib-type="author" equal-contrib="yes"><name><surname>Sun</surname><given-names>Zhe</given-names></name><xref ref-type="aff" rid="Aff1">1</xref></contrib><contrib contrib-type="author" equal-contrib="yes"><name><surname>Chen</surname><given-names>Li</given-names></name><xref ref-type="aff" rid="Aff2">2</xref></contrib><contrib contrib-type="author"><name><surname>Xin</surname><given-names>Hongyi</given-names></name><xref ref-type="aff" rid="Aff3">3</xref></contrib><contrib contrib-type="author"><name><surname>Jiang</surname><given-names>Yale</given-names></name><xref ref-type="aff" rid="Aff3">3</xref><xref ref-type="aff" rid="Aff4">4</xref></contrib><contrib contrib-type="author"><name><surname>Huang</surname><given-names>Qianhui</given-names></name><xref ref-type="aff" rid="Aff5">5</xref></contrib><contrib contrib-type="author"><name><surname>Cillo</surname><given-names>Anthony R.</given-names></name><xref ref-type="aff" rid="Aff6">6</xref></contrib><contrib contrib-type="author"><name><surname>Tabib</surname><given-names>Tracy</given-names></name><xref ref-type="aff" rid="Aff7">7</xref></contrib><contrib contrib-type="author"><name><surname>Kolls</surname><given-names>Jay K.</given-names></name><xref ref-type="aff" rid="Aff8">8</xref></contrib><contrib contrib-type="author"><name><surname>Bruno</surname><given-names>Tullia C.</given-names></name><xref ref-type="aff" rid="Aff6">6</xref><xref ref-type="aff" rid="Aff9">9</xref></contrib><contrib contrib-type="author"><name><surname>Lafyatis</surname><given-names>Robert</given-names></name><xref ref-type="aff" rid="Aff7">7</xref></contrib><contrib contrib-type="author"><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-2771-5992</contrib-id><name><surname>Vignali</surname><given-names>Dario A. A.</given-names></name><xref ref-type="aff" rid="Aff6">6</xref><xref ref-type="aff" rid="Aff9">9</xref><xref ref-type="aff" rid="Aff10">10</xref></contrib><contrib contrib-type="author"><name><surname>Chen</surname><given-names>Kong</given-names></name><xref ref-type="aff" rid="Aff11">11</xref></contrib><contrib contrib-type="author" corresp="yes"><name><surname>Ding</surname><given-names>Ying</given-names></name><address><email>yingding@pitt.edu</email></address><xref ref-type="aff" rid="Aff1">1</xref></contrib><contrib contrib-type="author" corresp="yes"><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-0987-2916</contrib-id><name><surname>Hu</surname><given-names>Ming</given-names></name><address><email>hum@ccf.org</email></address><xref ref-type="aff" rid="Aff12">12</xref></contrib><contrib contrib-type="author" corresp="yes"><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-7196-8703</contrib-id><name><surname>Chen</surname><given-names>Wei</given-names></name><address><email>wei.chen@chp.edu</email></address><xref ref-type="aff" rid="Aff1">1</xref><xref ref-type="aff" rid="Aff3">3</xref></contrib><aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 9000</institution-id><institution-id institution-id-type="GRID">grid.21925.3d</institution-id><institution>Department of Biostatistics, Graduate School of Public Health, </institution><institution>University of Pittsburgh, </institution></institution-wrap>Pittsburgh, PA 15261 USA </aff><aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0001 2297 8753</institution-id><institution-id institution-id-type="GRID">grid.252546.2</institution-id><institution>Department of Health Outcomes Research and Policy, </institution><institution>Harrison School of Pharmacy, Auburn University, </institution></institution-wrap>Auburn, AL 36849 USA </aff><aff id="Aff3"><label>3</label>Division of Pulmonary Medicine, Department of Pediatrics, Children&#x02019;s Hospital of Pittsburgh of UPMC, University of Pittsburgh, Pittsburgh, PA 15224 USA </aff><aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0001 0662 3178</institution-id><institution-id institution-id-type="GRID">grid.12527.33</institution-id><institution>School of Medicine, </institution><institution>Tsinghua University, </institution></institution-wrap>Beijing, 100084 China </aff><aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="ISNI">0000000086837370</institution-id><institution-id institution-id-type="GRID">grid.214458.e</institution-id><institution>Department of Biostatistics, School of Public Health, </institution><institution>University of Michigan, </institution></institution-wrap>Ann Arbor, MI 48109 USA </aff><aff id="Aff6"><label>6</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 9000</institution-id><institution-id institution-id-type="GRID">grid.21925.3d</institution-id><institution>Department of Immunology, School of Medicine, </institution><institution>University of Pittsburgh, </institution></institution-wrap>Pittsburgh, PA 15262 USA </aff><aff id="Aff7"><label>7</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 9000</institution-id><institution-id institution-id-type="GRID">grid.21925.3d</institution-id><institution>Division of Rheumatology and Clinical Immunology, Department of Medicine, School of Medicine, </institution><institution>University of Pittsburgh, </institution></institution-wrap>Pittsburgh, PA 15261 USA </aff><aff id="Aff8"><label>8</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0001 2217 8588</institution-id><institution-id institution-id-type="GRID">grid.265219.b</institution-id><institution>School of Medicine, </institution><institution>Tulane University, </institution></institution-wrap>New Orleans, LA 70112 USA </aff><aff id="Aff9"><label>9</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0456 9819</institution-id><institution-id institution-id-type="GRID">grid.478063.e</institution-id><institution>Tumor Microenvironment Center, </institution><institution>UPMC Hillman Cancer Center, </institution></institution-wrap>Pittsburgh, PA 15232 USA </aff><aff id="Aff10"><label>10</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0456 9819</institution-id><institution-id institution-id-type="GRID">grid.478063.e</institution-id><institution>Cancer Immunology and Immunotherapy Program, </institution><institution>UPMC Hillman Cancer Center, </institution></institution-wrap>Pittsburgh, PA 15232 USA </aff><aff id="Aff11"><label>11</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 9000</institution-id><institution-id institution-id-type="GRID">grid.21925.3d</institution-id><institution>Division of Pulmonary, Allergy and Critical Care Medicine, Department of Medicine, School of Medicine, </institution><institution>University of Pittsburgh, </institution></institution-wrap>Pittsburgh, PA 15213 USA </aff><aff id="Aff12"><label>12</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0001 0675 4725</institution-id><institution-id institution-id-type="GRID">grid.239578.2</institution-id><institution>Department of Quantitative Health Sciences, </institution><institution>Lerner Research Institute, Cleveland Clinic Foundation, </institution></institution-wrap>Cleveland, OH 44195 USA </aff></contrib-group><pub-date pub-type="epub"><day>9</day><month>4</month><year>2019</year></pub-date><pub-date pub-type="pmc-release"><day>9</day><month>4</month><year>2019</year></pub-date><pub-date pub-type="collection"><year>2019</year></pub-date><volume>10</volume><elocation-id>1649</elocation-id><history><date date-type="received"><day>6</day><month>8</month><year>2018</year></date><date date-type="accepted"><day>15</day><month>3</month><year>2019</year></date></history><permissions><copyright-statement>&#x000a9; The Author(s) 2019</copyright-statement><license license-type="OpenAccess"><license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article&#x02019;s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article&#x02019;s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p></license></permissions><abstract id="Abs1"><p id="Par1">The recently developed droplet-based single-cell transcriptome sequencing (scRNA-seq) technology makes it feasible to perform a population-scale scRNA-seq study, in which the transcriptome is measured for tens of thousands of single cells from multiple individuals. Despite the advances of many clustering methods, there are few tailored methods for population-scale scRNA-seq studies. Here, we develop a Bayesian mixture model for single-cell sequencing (BAMM-SC) method to cluster scRNA-seq data from multiple individuals simultaneously. BAMM-SC takes raw count data as input and accounts for data heterogeneity and batch effect among multiple individuals in a unified Bayesian hierarchical model framework. Results from extensive simulation studies and applications of BAMM-SC to in-house experimental scRNA-seq datasets using blood, lung and skin cells from humans or mice demonstrate that BAMM-SC outperformed existing clustering methods with considerable improved clustering accuracy, particularly in the presence of heterogeneity among individuals.</p></abstract><abstract id="Abs2" abstract-type="web-summary"><p id="Par2">With the development of large scale single cell RNA-seq technology, population-scale scRNA-seq studies are emerging. Here, the authors develop BAMM-SC, a tool for clustering droplet-based scRNA-seq data from multiple individuals simultaneously.</p></abstract><custom-meta-group><custom-meta><meta-name>issue-copyright-statement</meta-name><meta-value>&#x000a9; The Author(s) 2019</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="Sec1" sec-type="introduction"><title>Introduction</title><p id="Par3">Single-cell RNA sequencing (scRNA-seq) technologies have been widely used to measure gene expression for each individual cell, facilitating a deeper understanding of cell heterogeneity and better characterization of rare cell types<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR2">2</xref></sup>. Compared to early generation scRNA-seq technologies, the recently developed droplet-based technology, largely represented by the 10x Genomics Chromium system, has quickly gained popularity because of its high throughput (tens of thousands of single cells per run), high efficiency (a couple of days), and relatively lower cost (&#x0003c;$1 per cell)<sup><xref ref-type="bibr" rid="CR3">3</xref>&#x02013;<xref ref-type="bibr" rid="CR6">6</xref></sup>. It is now feasible to conduct population-scale single-cell transcriptomic profiling studies, where several to tens or even hundreds of individuals are sequenced<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>.</p><p id="Par4">A major task of analyzing droplet-based scRNA-seq data is to identify clusters of single cells with similar transcriptomic profiles. To achieve this goal, classic unsupervised clustering methods such as K-means clustering, hierarchical clustering, and density-based clustering approaches<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> can be applied after some normalization steps. Recently, scRNA-seq tailored unsupervised methods, such as SIMLR<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>, CellTree<sup><xref ref-type="bibr" rid="CR10">10</xref></sup>, SC3<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>, TSCAN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, and DIMM-SC<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>, have been designed and proposed for clustering scRNA-seq data. Supervised methods, such as MetaNeighbor, have been proposed to assess how well cell-type-specific transcriptional profiles replicate across different datasets<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>. However, none of these methods explicitly considers the heterogeneity among multiple individuals from population studies. In a typical analysis of population-scale scRNA-seq data, reads from each individual are processed separately and then merged together for the downstream analysis. For example, in the 10x Genomics Cell Ranger pipeline, to aggregate multiple libraries, reads from different libraries are downsampled such that all libraries have the same sequencing depth, leading to substantial information loss for individuals with higher sequencing depth. Alternatively, reads can be naively merged across all individuals without any library adjustment, leading to batch effects and unreliable clustering results.</p><p id="Par5">Similar to the analysis of other omics data, several computational approaches have been proposed to correct batch effects for scRNA-seq data. For example, Spitzer et al.<sup><xref ref-type="bibr" rid="CR15">15</xref></sup> adapted the concept of force-directed graph to visualize complex cellular samples via Scaffold (single-cell analysis by fixed force- and landmark-directed) maps, which can overlay data from multiple samples onto a reference sample(s). Recently, two new methods: mutual nearest neighbors<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> (MNN) (implemented in scran) and canonical correlation analysis (CCA)<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> (implemented in Seurat) were published for batch correction of scRNA-seq data. All these methods require the raw counts to be transformed to continuous values under different assumptions, which may alter the data structure in some cell types and lead to difficulty of biological interpretation.</p><p id="Par6">We first conducted an exploratory data analysis to demonstrate the existence of batch effect in multiple individuals using both publicly available and three in-house synthetic droplet-based scRNA-seq datasets, including human peripheral blood mononuclear cells (PBMC), mouse lung and human skin tissues. Detailed sample information was summarized in Fig.&#x000a0;<xref rid="Fig1" ref-type="fig">1a</xref> and Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">1</xref>. We use human PBMC as an example. We isolated from whole blood obtained from 4 healthy donors and used the 10x Chromium system to generate scRNA-seq data. We also included one additional healthy donor from a published PBMC scRNA-seq data<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> to mimic the scenario where we combine the local dataset with the public datasets. In this cohort, sample 1 and sample 2 were sequenced in one batch; sample 3 and sample 4 were sequenced in another batch; sample 5 was downloaded from the original study conducted by 10x Genomics<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>. As an exploratory analysis, we produced a t-SNE plot based on the first 50 principal components (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">1</xref>) of all cells from these 5 donors and observed a clear batch effect: samples from the same batch tend to cluster together.<fig id="Fig1"><label>Fig. 1</label><caption><p>Sample information of real scRNA-seq datasets and the model structure in BAMM-SC. <bold>a</bold> UMI counts per cell of three droplet-based scRNA-seq datasets. In the boxplots, the box spans from the first to third quartile (depicting median as a line in the middle), the whiskers extend to 1.5&#x000d7; IQR (interquartile range). <bold>b</bold> An overall workflow of BAMM-SC</p></caption><graphic xlink:href="41467_2019_9639_Fig1_HTML" id="d29e595"/></fig></p><p id="Par7">This illustrative example demonstrates the importance and urgent need for well characterizing different sources of variability and correcting potential batch effects among droplet-based scRNA-seq datasets collected from multiple individuals. In addition, due to the computational burden, many methods cannot be scaled up to analyze population-scale droplet-based scRNA-seq data with tens of thousands of cells collected from many individuals under various conditions. In this study, we propose a BAyesian Mixture Model for Single Cell sequencing (BAMM-SC) to simultaneously cluster large-scale droplet-based scRNA-seq data from multiple individuals. BAMM-SC directly works on the raw counts without any data transformation and models the heterogeneity from multiple sources by learning the distributions of signature genes in a Bayesian hierarchical model framework. In the following sections, we will describe our method, benchmark its performance against existing clustering methods in simulation studies, and evaluate our method for its accuracy, stability, and efficiency in three in-house synthetic scRNA-seq datasets including PBMCs, skin, and lung tissues from humans or mice.</p></sec><sec id="Sec2" sec-type="results"><title>Results</title><sec id="Sec3"><title>Overview of BAMM-SC</title><p id="Par8">BAMM-SC represents a Bayesian hierarchical Dirichlet multinomial mixture model, which explicitly characterizes three sources of heterogeneity (i.e., genes, cell types, and individuals) (see Methods). Figure&#x000a0;<xref rid="Fig1" ref-type="fig">1b</xref> provides an overview of the model structure in BAMM-SC, which directly models cell-type specific genes&#x02019; unique molecular identifier (UMI) counts and their heterogeneity among different individuals through a hierarchical distribution structure in a Bayesian framework. Our method has the following three key realistic assumptions. First, cell type clusters are discrete, and each cell belongs to one specific type exclusively. Second, heterogeneity exists among different individuals and across different cell types. The heterogeneity of the same cell type among different individuals is smaller than the heterogeneity across different cell types within the same individual. Third, cells of the same cell type share a similar gene expression pattern. That is, the underlying statistical distributions for cells within the same cell type are assumed to be the same. The mathematical model representations are included and explained in Supplementary&#x000a0;<xref rid="MOESM1" ref-type="media">Methods</xref>. Compared to other clustering methods which ignore individual level variability, BAMM-SC has the following four key advantages: (1) BAMM-SC accounts for data heterogeneity among multiple individuals, such as unbalanced sequencing depths and technical biases in library preparation, and thus reduces the false positives of detecting individual-specific cell types. (2) BAMM-SC borrows information across different individuals, leading to improved power for detecting individual-shared cell types and higher reproducibility as well as stability of the clustering results. (3) BAMM-SC performs one-step clustering on raw UMI count matrix without any prior batch-correction step, which is required for most clustering methods in the presence of batch effect. (4) BAMM-SC provides a statistical framework to quantify the clustering uncertainty for each cell in the form of posterior probability for each cell type (see Methods).</p></sec><sec id="Sec4"><title>Simulation studies</title><p id="Par9">We have conducted comprehensive simulation studies to benchmark the performance of BAMM-SC. Specifically, we simulated droplet-based scRNA-seq data collected from multiple individuals from the posited Bayesian hierarchical Dirichlet multinomial mixture model (see Methods and Supplementary&#x000a0;<xref rid="MOESM1" ref-type="media">Methods</xref>). We considered different experimental designs, including different heterogeneities among multiple individuals and different numbers of individuals (Fig.&#x000a0;<xref rid="Fig2" ref-type="fig">2</xref>). In our posited hierarchical model, the log normal prior distribution LN <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(\mu _{ik},\sigma _{ik}^2)$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq1.gif"/></alternatives></inline-formula> measures the heterogeneity of gene <italic>i</italic> in cell type <italic>k</italic> among multiple individuals, where <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{ik}$$\end{document}</tex-math><mml:math id="M4"><mml:msub><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq2.gif"/></alternatives></inline-formula> and <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{ik}^2$$\end{document}</tex-math><mml:math id="M6"><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq3.gif"/></alternatives></inline-formula> are related to the mean and variation of gene expression. Without loss of generality, we used the mean of <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{ik}^2$$\end{document}</tex-math><mml:math id="M8"><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq4.gif"/></alternatives></inline-formula> across all genes and all cell types to quantify the overall individual level heterogeneity. We applied BAMM-SC to each synthetic dataset, and compared the inferred cell type label of each single cell with the ground truth, measured by adjusted Rand index (ARI)<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. We compared BAMM-SC with other competing clustering methods (K-means, TSCAN, SC3, and Seurat), which are either methods from different clustering categories or recommended by recent reviews on clustering methods for single-cell data<sup><xref ref-type="bibr" rid="CR19">19</xref>,<xref ref-type="bibr" rid="CR20">20</xref></sup>. Since none of methods model batch effects and therefore each needs to be combined with a batch correction method as a preprocessing step in data analysis. We applied two recently published and prevalent methods srcan MNN<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> and Seurat CCA<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> prior to these clustering methods so that each combination can be a fair comparison with BAMM-SC, which does not need a separate batch correction step.<fig id="Fig2"><label>Fig. 2</label><caption><p>Boxplots of ARIs for 10 clustering methods across 100 simulations. <bold>a</bold> Investigating how different heterogeneities among multiple individuals (measured by mean <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{ik}^2$$\end{document}</tex-math><mml:math id="M10"><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq5.gif"/></alternatives></inline-formula> values) affect clustering results. The simulated dataset consists of 10 individuals with 400 cells for each. <bold>b</bold> Investigating how different numbers of individuals affect clustering results. We set the level of heterogeneity (mean of <inline-formula id="IEq6"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{ik}^2$$\end{document}</tex-math><mml:math id="M12"><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq6.gif"/></alternatives></inline-formula>) among individuals as 0.1. In the boxplots, the box spans from the first to third quartile (depicting median as a line in the middle), the whiskers extend to 1.5&#x000d7; IQR (interquartile range)</p></caption><graphic xlink:href="41467_2019_9639_Fig2_HTML" id="d29e798"/></fig></p><p id="Par10">Specifically, we compared BAMM-SC with the other nine competing methods (MNN+K-means, MNN+TSCAN, MNN+SC3, MNN+Seurat, CCA+K-means, CCA+TSCAN, CCA+SC3, CCA+Seurat, and DIMM-SC) in the simulation studies. Noticeably, DIMM-SC, our previously developed method for clustering scRNA-seq data from a single individual, also takes the raw UMI count matrix as the input without any batch effect correction or data transformation. We pooled single cells from different individuals together while ignoring each individual label, and then applied DIMM-SC to the pooled data. We simulated 100 datasets and summarized the corresponding ARIs for each method.</p><p id="Par11">As shown in Fig.&#x000a0;<xref rid="Fig2" ref-type="fig">2a</xref>, BAMM-SC consistently outperformed the other nine competing methods across a variety of individual level heterogeneities by achieving higher average ARI and lower variation of ARI among 100 simulations. As expected, the performance of all ten clustering approaches decreases as the among individual heterogeneity increases, measured by the mean <inline-formula id="IEq7"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{ik}^2$$\end{document}</tex-math><mml:math id="M14"><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq7.gif"/></alternatives></inline-formula> values. In Fig.&#x000a0;<xref rid="Fig2" ref-type="fig">2b</xref>, with the increase of number of individuals, BAMM-SC achieved higher ARI, while ARIs of other methods either remained stable or decreased.</p><p id="Par12">Furthermore, we performed comprehensive simulation studies by generating simulated scRNA-seq datasets from different number of cell type clusters (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">2a</xref>), different overall sequencing depths (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">2b</xref>), and different cell-type-specific heterogeneities (i.e., the mean difference of gene expression profiles between two distinct cell types) (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">2c</xref>). BAMM-SC consistently outperformed other methods in terms of accuracy and robustness in all these scenarios. Taken together, our comprehensive simulation studies have demonstrated that, when data are generated from the true model, BAMM-SC is able to appropriately borrow information across multiple individuals, account for unbalanced sequencing depths, and provide more accurate and robust clustering results than other competing methods.</p><p id="Par13">To evaluate the robustness of BAMM-SC when data generation model is mis-specified, we simulated additional datasets using R package Splatter<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, a commonly used tool for scRNA-seq data simulation using a completely different model. To make our simulated data a good approximation to the real data, we first downloaded the raw UMI count matrix of a purified B-cell scRNA-seq dataset from the 10x Genomics website (<ext-link ext-link-type="uri" xlink:href="https://support.10xgenomics.com/single-cell-gene-expression/datasets/1.1.0/b_cells">https://support.10xgenomics.com/single-cell-gene-expression/datasets/1.1.0/b_cells</ext-link>), and used the function splatEstimate to estimate the parameters related to mean of gene, library size, expression outlier, dispersion across genes, and dropout rate. We assumed cell types are shared across multiple individuals, where each individual is treated as one batch with the same number of cells and genes. We further specified batch parameters and differential expression parameters to generate scenarios with different amount of group effect (i.e., cell type differences) and batch effect. As shown in Fig.&#x000a0;<xref rid="Fig3" ref-type="fig">3</xref>, BAMM-SC still outperformed most other competing methods in terms of clustering accuracy in all scenarios, although the improvement is less substantial than our own model simulations, which is expected.<fig id="Fig3"><label>Fig. 3</label><caption><p>Boxplots of ARI for 10 clustering methods across 100 simulations using Splatter. <bold>a</bold> Investigating how different levels of group effect affect clustering results. We set the mean parameters of three cell types as (0.20, 0.21, 0.22), (0.20, 0.22, 0.24), and (0.20, 0.24, 0.28) to represent three levels (low, medium, and high) of group difference. <bold>b</bold> Investigating how different levels of batch effect affect clustering results. We set the mean parameters of the five individuals as (0.1, 0.1, 0.1, 0.1, 0.1), (0.12, 0.12, 0.12, 0.12, 0.12), and (0.14, 0.14, 0.14, 0.14, 0.14) to represent three levels (low, medium, and high) of batch effects. In the boxplots, the box spans from the first to third quartile (depicting median as a line in the middle), the whiskers extend to 1.5&#x000d7; IQR (interquartile range)</p></caption><graphic xlink:href="41467_2019_9639_Fig3_HTML" id="d29e868"/></fig></p></sec><sec id="Sec5"><title>Real data analysis on human PMBC dataset</title><p id="Par14">For aforementioned human PBMC samples, we first pooled cells from five donors together, filtered lowly expressed genes that were expressed in less than 1% cells. We then extracted the top 1000 highly variable genes based on their standard deviations. As shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">3</xref>, we identified seven types of PBMCs based on the biological knowledge of cell-type-specific gene markers (Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">2</xref>). Using these gene markers, &#x0003e;70% single cells can be assigned to a specific cell type. Since there is no gold standard for clustering analysis in this real dataset, we used the labels of these cells as the approximated ground truth to benchmark the clustering performance for different clustering methods. Cells with uncertain cell types were removed when calculating ARIs.</p><p id="Par15">Similar to the simulation studies, we applied ten clustering methods on these samples and repeated each method ten times to evaluate the stability of its performance (Table&#x000a0;<xref rid="Tab1" ref-type="table">1</xref>). The total number of clusters was set as seven based on the biological knowledge from cell-type-specific gene markers. As shown in Table&#x000a0;<xref rid="Tab1" ref-type="table">1</xref>, BAMM-SC achieved the highest ARI for human PBMC samples compared to all other competing methods. Both TSCAN and Seurat are deterministic clustering methods and therefore they generate identical results for ten analyses.<table-wrap id="Tab1"><label>Table 1</label><caption><p>Performance of clustering across ten times analyses for three real datasets</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Method</th><th>Mean_P</th><th>SD_P</th><th>Range_P</th><th>Mean_L</th><th>SD_L</th><th>Range_L</th><th>Mean_S</th><th>SD_S</th><th>Range_S</th></tr></thead><tbody><tr><td>MNN+K-means</td><td>0.379</td><td>0.083</td><td>(0.283&#x02013;0.485)</td><td>0.662</td><td>0.066</td><td>(0.596&#x02013;0.815)</td><td>0.597</td><td>0.075</td><td>(0.461&#x02013;0.676)</td></tr><tr><td>MNN+TSCAN</td><td>0.373</td><td>NA</td><td>NA</td><td>0.720</td><td>NA</td><td>NA</td><td>0.553</td><td>NA</td><td>NA</td></tr><tr><td>MNN+SC3</td><td>0.348</td><td>0.084</td><td>(0.266&#x02013;0.511)</td><td>0.640</td><td>0.061</td><td>(0.556&#x02013;0.687)</td><td>0.517</td><td>0.034</td><td>(0.436&#x02013;0.557)</td></tr><tr><td>MNN+Seurat</td><td>0.325</td><td>NA</td><td>NA</td><td>0.749</td><td>NA</td><td>NA</td><td>0.647</td><td>NA</td><td>NA</td></tr><tr><td>CCA+K-means</td><td>0.414</td><td>0.056</td><td>(0.307&#x02013;0.464)</td><td>0.695</td><td>0.114</td><td>(0.505&#x02013;0.883)</td><td>0.619</td><td>0.129</td><td>(0.424&#x02013;0.737)</td></tr><tr><td>CCA+TSCAN</td><td>0.210</td><td>NA</td><td>NA</td><td>0.611</td><td>NA</td><td>NA</td><td>0.398</td><td>NA</td><td>NA</td></tr><tr><td>CCA+SC3</td><td>0.145</td><td>0.052</td><td>(0.051&#x02013;0.215)</td><td>0.610</td><td>0.068</td><td>(0.531&#x02013;0.708)</td><td>0.369</td><td>0.071</td><td>(0.277&#x02013;0.488)</td></tr><tr><td>CCA+Seurat</td><td>0.468</td><td>NA</td><td>NA</td><td>0.729</td><td>NA</td><td>NA</td><td>0.702</td><td>NA</td><td>NA</td></tr><tr><td>DIMM-SC</td><td>0.333</td><td>0.071</td><td>(0.302&#x02013;0.529)</td><td>0.809</td><td>0.030</td><td>(0.742&#x02013;0.868)</td><td>0.715</td><td>0.045</td><td>(0.671&#x02013;0.779)</td></tr><tr><td>BAMM-SC</td><td>0.487</td><td>0.056</td><td>(0.362&#x02013;0.532)</td><td>0.882</td><td>0.042</td><td>(0.764&#x02013;0.910)</td><td>0.762</td><td>0.032</td><td>(0.717&#x02013;0.843)</td></tr></tbody></table><table-wrap-foot><p>Columns Mean_P, SD_P, and Range_P were calculated from human PBMC dataset. Columns Mean_L, SD_L, and Range_L were calculated from mouse lung dataset. Columns Mean_S, SD_S, and Range_S were calculated from human skin dataset.</p></table-wrap-foot></table-wrap></p><p id="Par16">We further generated t-SNE plots with each cell colored by their cell-type classification based on specific gene markers (i.e., the approximated truth) (Fig.&#x000a0;<xref rid="Fig4" ref-type="fig">4a</xref> (left figure)) and cluster labels inferred by BAMM-SC (Fig.&#x000a0;<xref rid="Fig4" ref-type="fig">4a</xref> (middle figure)), respectively. Despite some dendritic cells were wrongly identified as CD16+Monocytes, these two plots are similar to each other (ARI&#x02009;=&#x02009;0.532), suggesting that BAMM-SC performed well in human PBMC samples compared with other clustering methods.<fig id="Fig4"><label>Fig. 4</label><caption><p>The performance of BAMM-SC clustering for three in-house scRNA-seq datasets. The t-SNE projection of cells (colored by the approximated truth and BAMM-SC clustering results) and bar plots of proportions of cell types among all individuals for <bold>a</bold> human PBMC, <bold>b</bold> mouse lung, and <bold>c</bold> human skin tissues, separately. BAMM-SC clustering labels are from the result with the highest ARI among ten times analysis</p></caption><graphic xlink:href="41467_2019_9639_Fig4_HTML" id="d29e1278"/></fig></p><p id="Par17">Moreover, we calculated the averaged cell proportions of each cell type inferred from BAMM-SC among ten runs for five PBMC samples, compared with cell proportions calculated from the approximated truth based on gene markers. Figure&#x000a0;<xref rid="Fig4" ref-type="fig">4a</xref> (right figure) shows that the proportions inferred from BAMM-SC are close to the truth, suggesting that BAMM-SC can adequately account for batch effect when clustering cells from multiple individuals. We also generated t-SNE projection plots colored by cluster labels inferred by other methods: MNN+K-means clustering (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4a</xref>), MNN+TSCAN (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4b</xref>), MNN+SC3 (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4c</xref>), MNN+Seurat (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4d</xref>), CCA+K-means (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4e</xref>), CCA+TSCAN (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4f</xref>), CCA+SC3 (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4g</xref>), CCA+Seurat (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4h</xref>), and DIMM-SC (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">4i</xref>).</p></sec><sec id="Sec6"><title>Real data analysis on mouse lung dataset</title><p id="Par18">We collected lung mononuclear cells from four mouse samples under two conditions: <italic>Streptococcus pneumonia</italic> (SP) infected (sample 1 and 2) and naive (sample 3 and 4). Supplementary Figure&#x000a0;<xref rid="MOESM1" ref-type="media">5</xref> shows the t-SNE plot of lung mononuclear cells from four mouse samples. Similar to the analysis of PBMC samples, after filtering lowly expressed genes, we pooled cells from 4 mice together and extracted the top 1000 highly variable genes. As shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">6</xref>, we identified six types of cells based on the biological knowledge of cell-type specific gene markers (Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">3</xref>). Taken together, &#x0003e;66% of single cells can be assigned to a specific cell type. Therefore, we used the labels of these cells as the approximated truth and removed cells with uncertain cell types from the downstream analysis.</p><p id="Par19">Figure&#x000a0;<xref rid="Fig4" ref-type="fig">4b</xref> (left figure) and Fig.&#x000a0;<xref rid="Fig4" ref-type="fig">4b</xref> (middle figure) show the t-SNE plots with each cell colored by their cluster label based on cell-type-specific gene markers and cluster labels inferred by BAMM-SC, respectively. These two are highly similar (ARI&#x02009;=&#x02009;0.910), indicating the outstanding performance of BAMM-SC. Table&#x000a0;<xref rid="Tab1" ref-type="table">1</xref> shows that BAMM-SC considerably outperformed other nine clustering methods in terms of ARI. We also generated t-SNE plots colored by cluster labels inferred by other competing clustering methods (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">7</xref>). As shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">8</xref>, the proportions of neutrophils in SP infected samples (sample 1 and sample 2) are much higher than the proportions in na&#x000ef;ve samples (sample 3 and sample 4). This is consistent with the fact that infections by bacteria and viruses may increase the number of neutrophils, which is a necessary reaction by the body<sup><xref ref-type="bibr" rid="CR22">22</xref>,<xref ref-type="bibr" rid="CR23">23</xref></sup>. Interestingly, the proportion of cell types in na&#x000ef;ve sample 3 is different from others, which may due to unsatisfactory sample quality or unexpected bacterial infections.</p></sec><sec id="Sec7"><title>Real data analysis on human skin dataset</title><p id="Par20">To evaluate the clustering performance of BAMM-SC in solid human tissues, we collected skin samples from five healthy donors that are part of a systemic sclerosis study<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>. Figure&#x000a0;<xref rid="Fig1" ref-type="fig">1a</xref> and Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">1</xref> list the detailed sample information and Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">9</xref> shows the t-SNE plot of cells from five human skin samples after the data processing similar to previous analyses. As shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">10</xref>, we identified eight major types of cells based on the biological knowledge of cell-type-specific gene markers (Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">4</xref>). Taken together, &#x0003e;67% of single cells can be assigned to a specific cell type. Similar to the other two real data analyses, we used the labels of these cells as the approximated truth and removed cells with uncertain cell types from the downstream analysis.</p><p id="Par21">As shown in Fig.&#x000a0;<xref rid="Fig3" ref-type="fig">3c</xref>, BAMM-SC performed well in human skin samples, since the t-SNE plot with each cell colored by their cell-type label based on gene markers is highly similar to the plot generated from the clustering result of BAMM-SC (ARI&#x02009;=&#x02009;0.843). Also, BAMM-SC achieved higher ARI compared with all the other clustering methods (Table&#x000a0;<xref rid="Tab1" ref-type="table">1</xref>). As comparisons, we generated t-SNE plots colored by cluster labels inferred by different clustering (Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">11</xref>).</p></sec><sec id="Sec8"><title>Other evaluation criteria</title><p id="Par22">To further demonstrate the validity of BAMM-SC, we calculated the confusion matrix for three real datasets and reported the clustering accuracy (defined as the proportion of cells being classified into the correct cell-type cluster) (Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">5</xref>, Supplementary Methods). Our method outperformed other competing methods in all three datasets. In addition, we performed a flow cytometry experiment, a gold standard method for quantifying cell population through cell surface markers, on the sample 3 from the human PBMC dataset, which has an additional aliquot from the same pool of cells. We used FlowJo software to gate each cell population through specific antibodies and calculated the percentage of each cell type. Then, we compared the proportions of different cell types from flow cytometry and the clustering result of BAMM-SC from scRNA-seq. Supplementary Figure&#x000a0;<xref rid="MOESM1" ref-type="media">12</xref> shows that the proportion of cells in each cell type classified by BAMM-SC is consistent with that being estimated by flow cytometry. We also calculated the Pearson&#x02019;s correlation coefficient of cell proportions for each clustering method (Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">6</xref>). Despite the different technology, the high correlation (Pearson correlation coefficient is 0.98) suggests that BAMM-SC is able to adequately account for heterogeneity among multiple individuals and provide reliable clustering results. To be noted, unlike other clustering methods we considered, Seurat cannot directly pre-specify the number of clusters K. Rather it needs to set a resolution parameter that indirectly controls the cluster number. In all three real data sets, after an extensive grid search, we found the resolution parameter that yields the same number of clusters as the one based on the biological knowledge. Therefore, for the two Seurat clustering methods, instead of using the clustering assignments that produced the highest ARI among ten times analysis, we computed the confusion matrix and the proportions of different cell types based on this specific resolution parameter.</p><p id="Par23">It is challenging to evaluate clustering algorithms in experimental data since the ground truth of cell type label is generally unknown. Other than using ARI based on cell-type-specific gene markers as approximated ground truth, we also used cluster stability and tightness to evaluate the clustering performance. Specifically, we calculated the average proportion of nonoverlap (APN)<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> clustered cells and silhouette width<sup><xref ref-type="bibr" rid="CR26">26</xref></sup> in three real datasets, respectively. APN is a cluster stability measurement which evaluates the stability of a clustering result by comparing it with the clusters obtained by removing one feature (i.e., one gene in our study) at a time. It measures the average proportion of observations not placed in the same cluster under both cases. To make computation affordable in our real data analysis, after extracting the top 1000 highly variable genes, we compared the clustering results based on the full data (1000 genes) to the clustering results based on a subset of data with 100 genes randomly removed. We repeated this step ten times to calculate the APN. For cluster tightness, the silhouette width ranges from &#x02212;1 to 1, where a higher value indicates that the observation is better matched to its own cluster and worse matched to other clusters. For both measurements, BAMM-SC achieved high cluster stability and high cluster tightness in most scenarios, compared with all other competing methods (Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">7</xref>, Supplementary Table&#x000a0;<xref rid="MOESM1" ref-type="media">8</xref>).</p></sec><sec id="Sec9"><title>Uncertainty assessment</title><p id="Par24">Different from other deterministic methods, BAMM-SC has the ability to assess clustering uncertainty through the posterior probability for each cell to belong to each cell-type cluster. As shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">13</xref>, we highlighted vague cells in the t-SNE projection plot, where vague cells are defined as cells with the largest posterior cluster-specific probability &#x0003c;0.95. In the human PBMC samples, most of the vague cells (colored in red) are located at the boundary of different clusters, which reassuring the validity of the clustering results. In real data analysis, users can decide to remove vague cells under a user-specified criterion (based on the posterior probability) for the downstream analysis such as differential gene expression analysis within each cell type.</p></sec></sec><sec id="Sec10" sec-type="discussion"><title>Discussion</title><p id="Par25">In summary, we have developed a novel Bayesian framework for clustering population-scale scRNA-seq data. BAMM-SC retains the raw data information by directly modeling UMI counts without data transformation or normalization, facilitating straightforward biological interpretation. The Bayesian hierarchical model enables the joint characterization of multiple sources of uncertainty, including single-cell level heterogeneity and individual level heterogeneity. Furthermore, BAMM-SC can borrow information across different individuals through its mixture hierarchical model structure and Bayesian computational techniques, leading to improved clustering accuracy. BAMM-SC is based on probabilistic models, thus providing the quantification of clustering uncertainty for each single cell.</p><p id="Par26">Our model coupled with a computationally efficient MCMC algorithm is able to cluster large-scale droplet-based scRNA-seq data with feasible computational cost. For example, using 1000 highly variable genes, it takes about 1.5, 2.5, and 4.5&#x02009;h when analyzing the 3 real datasets (human PBMC, mouse lung and human skin), respectively. For the simulated dataset consist of 10 individuals with 4000 cells each, the computational time for clustering is about 30&#x02009;min. Supplementary Figure <xref rid="MOESM1" ref-type="media">14</xref> demonstrates that the computational time of BAMM-SC increases approximately linearly with the increase of the number of cells in each individual, the number of individuals and the number of clusters, respectively. To further improve the computational efficiency, we provided a supervised clustering option in BAMM-SC for very large-scale datasets. Specifically, users can first apply BAMM-SC on a small subset of single cells in each individual, and save predicted cluster labels as well as other informative parameters such as <inline-formula id="IEq8"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq8.gif"/></alternatives></inline-formula>. Then for the remaining single cells, users can perform supervised classification via BAMM-SC instead of unsupervised clustering (see Methods). By clustering a small number of single cells, this procedure will substantially reduce the computational cost. We used the simulated dataset of ten individuals to demonstrate the effectiveness of this supervised option in Fig.&#x000a0;<xref rid="Fig5" ref-type="fig">5</xref>. We simulated two datasets (Supplementary&#x000a0;<xref rid="MOESM1" ref-type="media">Methods</xref>): one dataset consists of 10 individuals with 400 cells each and the other dataset consists of 10 individuals with 4000 cells each. We selected a subset of cells in each individual as the training set and treated the remaining cells as the test set. We set the proportion of cells in the training set from 10 to 100% and reported the ARIs for both training and test sets. When the proportion equals 100%, there is no test data set, thus only ARI for the training set is reported. We repeated this simulation procedure 100 times and reported ARIs in Fig.&#x000a0;<xref rid="Fig5" ref-type="fig">5</xref> below. When the total number of cells in the training set is large enough (4000 in total or more), the prediction performance (measured by ARI) in the test set is saturated. For the dataset consists of 10 individuals with 4000 cells each, when we used 10% cells for training, it only takes ~90&#x02009;s to obtain the clustering labels for all cells in both training and test sets with the similar performance from the full dataset. Therefore, for large datasets (e.g., &#x0003e;100&#x02009;K cells), users can apply BAMM-SC to a smaller subset of cells in each individual to cluster distinct cell types, and then classify the remaining cells according to the predicted cell types. BAMM-SC is currently implemented in R/Rcpp with satisfactory computing efficiency to accommodate population scale scRNA-seq data. Further speed-up can be made through parallel computing or graphics processing unit.<fig id="Fig5"><label>Fig. 5</label><caption><p>The Boxplots of ARI for BAMM-SC across 100 simulation. It demonstrates the clustering accuracy under different proportions of cells being selected in the training set. In the boxplots, the box spans from the first to third quartile (depicting median as a line in the middle), the whiskers extend to 1.5&#x000d7; IQR (interquartile range)</p></caption><graphic xlink:href="41467_2019_9639_Fig5_HTML" id="d29e1473"/></fig></p><p id="Par27">In addition, we can predefine the number of clusters based on prior knowledge on the tissue or determine it using some standard model checking criterion such as Akaike's Information Criteria (AIC) or Bayesian Information Criteria (BIC). As shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">15</xref>, AIC and BIC work as expected in the analysis of simulated datasets and provide a reliable range of cluster numbers to guide real data analysis based on prior knowledge. However, in a biological study, the number of clusters is often considered as a continuum because of the nature of cell growth, so we recommend trying a range of cluster numbers in practice. BAMM-SC is shown to be robust against model mis-specification. In our simulation studies, we applied Splatter to simulate scRNA-seq data in which the data generation mechanism is different from our proposed BAMM-SC model. BAMM-SC still achieved higher clustering accuracy than other competing methods. In addition, we compared BAMM-SC with other clustering methods when the number of clusters is different from the true number of cell types. Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">16</xref> shows that BAMM-SC still achieved the highest ARI in most scenarios.</p><p id="Par28">Other than MNN and CCA, several other approaches have been proposed to correct batch effect across multiple individuals. One straightforward approach is taking one individual as the reference, producing a low-dimensional embedding of it and then projecting the other individuals onto that embedding. To perform low-dimensional embedding, diffusion map<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> is a tool for nonlinear dimension reduction and has recently been adapted for the visualization of single-cell gene-expression data. In addition, single-cell variational inference (scVI) is a scalable framework for batch correction based on variational inference and stochastic optimization of deep neural networks<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. The performance of diffusion map and scVI combined with other clustering method was examined, which is worse than MNN and CCA in the three synthetic datasets (possibly due to unmet model underlying assumptions). We will explore more emerging methods in our future work.</p><p id="Par29">There are several limitations of BAMM-SC. First, we filtered out genes with excessive zeros from the analysis under the assumption that lowly-expressed genes do not contribute much to clustering. This may be problematic for rare cell type identification. Second, we do not explicitly model a zero-inflation pattern, which may or may not affect clustering accuracy. A refined model that can handle inflated zeros can be further developed with a balance between computational complexity and model flexibility. Third, in our model, we assume that each cell belongs to one distinct cluster. The posterior probability measures the clustering uncertainty, which cannot be directly interpreted as a quantification of cell cycle or developmental stage. Finally, although our supervised strategy is proven to work for large datasets efficiently, it may potentially miss some rare clusters.</p><p id="Par30">Our method has the potential to be extended to perform trajectory analysis<sup><xref ref-type="bibr" rid="CR29">29</xref>,<xref ref-type="bibr" rid="CR30">30</xref></sup>, and accounts for both individual and batch level heterogeneity (e.g., two individuals spread evenly across two 10x chips in a properly blocked design) by adding another level of structure. In addition, the model parameters can be used for downstream differential gene expression analysis or construct cell-type specific biomarker panels. These interesting directions are beyond the scope of this paper and will be studied in future papers. Additionally, unlike the traditional way of analyzing scRNA-seq data, BAMM-SC can be also used with batch effect correction. As shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">17</xref>, we ran BAMM-SC on the mouse lung dataset first and extracted cells in cluster 4. Then we applied CCA (implemented in Seurat) on this specific cluster of cells and replotted the t-SNE plot. From Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">17e</xref>, cells from different samples are superimposed on each other, suggesting that most batch effect has been removed. In practice, we recommend using BAMM-SC for clustering raw count data and then use other methods, such as MNN and CCA, to remove batch effect for each individual cell type if needed.</p><p id="Par31">We have applied BAMM-SC to simulated datasets and three in-house synthetic datasets to showcase its performance on different tissue types and species. With the increased popularity of population-based scRNA-seq studies, BAMM-SC will become a powerful tool for elucidating single cell level transcriptomic heterogeneity from population-based studies and a complementary approach to existing clustering methods.</p></sec><sec id="Sec11"><title>Methods</title><sec id="Sec12"><title>Statistical model</title><p id="Par32">We propose a Bayesian hierarchical Dirichlet multinomial mixture model to explicitly characterize different sources of variability in population scale scRNA-seq data. Specifically, let <inline-formula id="IEq9"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x_{ijl}$$\end{document}</tex-math><mml:math id="M18"><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq9.gif"/></alternatives></inline-formula> represent the number of unique UMIs for gene <italic>i</italic> in cell <italic>j</italic> from individual <italic>l</italic> (<inline-formula id="IEq10"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$1 \le i \le G$$\end{document}</tex-math><mml:math id="M20"><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>i</mml:mi><mml:mo>&#x02264;</mml:mo><mml:mi>G</mml:mi></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq10.gif"/></alternatives></inline-formula>, <inline-formula id="IEq11"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$1 \le j \le C_l$$\end{document}</tex-math><mml:math id="M22"><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>j</mml:mi><mml:mo>&#x02264;</mml:mo><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq11.gif"/></alternatives></inline-formula>, <inline-formula id="IEq12"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$1 \le l \le L$$\end{document}</tex-math><mml:math id="M24"><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>l</mml:mi><mml:mo>&#x02264;</mml:mo><mml:mi>L</mml:mi></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq12.gif"/></alternatives></inline-formula>). Here, <italic>G</italic>, <italic>C</italic><sub><italic>l</italic></sub>, and <italic>L</italic> denote the total number of genes, cells (in individual <italic>l</italic>), and individuals, respectively. Our goal is to perform simultaneous clustering for cells from all <italic>L</italic> individuals. We assume that within each individual, all single cells consist of <italic>K</italic> distinct cell types. Cell type clusters are discrete, and each cell belongs to one cell type exclusively. Here, <italic>K</italic> is predefined according to prior biological knowledge, or will be estimated from the data, and <italic>K</italic> is the same among all <italic>L</italic> individuals.</p><p id="Par33">Assume that <inline-formula id="IEq13"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{x}}_{ \cdot {\boldsymbol{jl}}} = (x_{1jl},x_{2jl}, \ldots ,x_{Gjl})$$\end{document}</tex-math><mml:math id="M26"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>&#x02026;</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>G</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq13.gif"/></alternatives></inline-formula>, the gene expression for cell <italic>j</italic> in individual <italic>l</italic>, follows a multinomial distribution multi <inline-formula id="IEq14"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left( {T_{jl},{\boldsymbol{p}}_{ \cdot {\boldsymbol{jl}}}} \right).$$\end{document}</tex-math><mml:math id="M28"><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq14.gif"/></alternatives></inline-formula> Here, <inline-formula id="IEq15"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$T_{jl} = \mathop {\sum }\limits_{i = 1}^G x_{ijl}$$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x02211;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq15.gif"/></alternatives></inline-formula> is the total number of UMIs, <inline-formula id="IEq16"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{p}}_{ \cdot {\boldsymbol{jl}}} = (p_{1jl},p_{2jl}, \ldots ,p_{Gjl})$$\end{document}</tex-math><mml:math id="M32"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>&#x02026;</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>G</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq16.gif"/></alternatives></inline-formula> is the probability vector for gene expression with <inline-formula id="IEq17"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathop {\sum }\limits_{i = 1}^G p_{ijl} = 1$$\end{document}</tex-math><mml:math id="M34"><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x02211;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq17.gif"/></alternatives></inline-formula>, (where larger <inline-formula id="IEq18"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p_{ijl}$$\end{document}</tex-math><mml:math id="M36"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq18.gif"/></alternatives></inline-formula> is associated with more UMI counts <inline-formula id="IEq19"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x_{ijl}$$\end{document}</tex-math><mml:math id="M38"><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq19.gif"/></alternatives></inline-formula>). In addition, let <inline-formula id="IEq20"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{jl} \in \{ 1,2, \ldots ,K\}$$\end{document}</tex-math><mml:math id="M40"><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02208;</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mn>2</mml:mn><mml:mo>,</mml:mo><mml:mo>&#x02026;</mml:mo><mml:mo>,</mml:mo><mml:mi>K</mml:mi></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq20.gif"/></alternatives></inline-formula> represent the cell type label for cell <italic>j</italic> in individual <italic>l</italic>, where <inline-formula id="IEq21"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{jl} = k$$\end{document}</tex-math><mml:math id="M42"><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq21.gif"/></alternatives></inline-formula> indicates that cell <italic>j</italic> in individual <italic>l</italic> belongs to cell type <italic>k</italic>. Cells of the same cell type share a similar gene-expression pattern. If cell <italic>j</italic> in individual <italic>l</italic> belongs to cell type <italic>k</italic> (<inline-formula id="IEq22"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{jl} = k$$\end{document}</tex-math><mml:math id="M44"><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq22.gif"/></alternatives></inline-formula>), we assume that <inline-formula id="IEq23"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{p}}_{ \cdot {\boldsymbol{jl}}}$$\end{document}</tex-math><mml:math id="M46"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq23.gif"/></alternatives></inline-formula> follows a cell-type specific Dirichlet prior Dir<inline-formula id="IEq24"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left( {{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}} \right)$$\end{document}</tex-math><mml:math id="M48"><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq24.gif"/></alternatives></inline-formula>, where <inline-formula id="IEq25"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}} = \left( {\alpha _{1lk},\alpha _{2lk}, \ldots ,\alpha _{Glk}} \right)$$\end{document}</tex-math><mml:math id="M50"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>&#x02026;</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>G</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq25.gif"/></alternatives></inline-formula> is the Dirichlet prior parameter for cell type <italic>k</italic> in individual <italic>l</italic>.<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {{\boldsymbol{p}}_{.{\boldsymbol{jl}}}|z_{jl} = k,{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}} \right) = \frac{1}{{B({\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}})}}p_{1jl}^{\alpha _{1lk} - 1}p_{2jl}^{\alpha _{2lk} - 1} \ldots p_{Gjl}^{\alpha _{Glk} - 1},$$\end{document}</tex-math><mml:math id="M52"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mrow><mml:mo>.</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>B</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:msubsup><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo>&#x02026;</mml:mo><mml:msubsup><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>G</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>G</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo>,</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq26"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$B(\alpha _{ \cdot lk})$$\end{document}</tex-math><mml:math id="M54"><mml:mi>B</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq26.gif"/></alternatives></inline-formula> is Beta function with parameter <inline-formula id="IEq27"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{ \cdot lk} = \left( {\alpha _{1lk},\alpha _{2lk}, \ldots ,\alpha _{Glk}} \right)$$\end{document}</tex-math><mml:math id="M56"><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>&#x02026;</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>G</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq27.gif"/></alternatives></inline-formula>. Then after integrating <inline-formula id="IEq28"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p_{ \cdot jl}$$\end{document}</tex-math><mml:math id="M58"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq28.gif"/></alternatives></inline-formula> out, we have:<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {{\boldsymbol{x}}_{ \cdot {\boldsymbol{jl}}}|z_{jl} = k,{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}} \right) = \frac{{T_{jl}!}}{{\mathop {\prod }\nolimits_{i = 1}^G x_{ijl}!}}\left( {\mathop {\prod }\limits_{i = 1}^G \frac{{{\mathrm{\Gamma }}(x_{ijl} + \alpha _{ilk})}}{{{\mathrm{\Gamma }}(\alpha _{ilk})}}} \right)\frac{{{\mathrm{\Gamma }}(|{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}|)}}{{{\mathrm{\Gamma }}(T_{jl} + |{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}|)}},$$\end{document}</tex-math><mml:math id="M60"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>!</mml:mo></mml:mrow><mml:mrow><mml:msubsup><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>!</mml:mo></mml:mrow></mml:mfrac><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq29"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left| {{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}} \right| = \mathop {\sum }\limits_{i = 1}^G \alpha _{ilk}$$\end{document}</tex-math><mml:math id="M62"><mml:mfenced close="&#x02223;" open="&#x02223;" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x02211;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq29.gif"/></alternatives></inline-formula>. The joint distribution of <inline-formula id="IEq30"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{x}}_{ \cdot {\boldsymbol{jl}}}$$\end{document}</tex-math><mml:math id="M64"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq30.gif"/></alternatives></inline-formula> and <inline-formula id="IEq31"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{jl}$$\end{document}</tex-math><mml:math id="M66"><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq31.gif"/></alternatives></inline-formula> is<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {{\boldsymbol{x}}_{ \cdot {\boldsymbol{jl}}},z_{jl}{\mathrm{|}}{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{l}} \cdot }} \right) = \frac{{T_{jl}!}}{{\mathop {\prod }\nolimits_{i = 1}^G x_{ijl}!}}\mathop {\sum }\limits_{k = 1}^K I(z_{jl} = k)\left( {\mathop {\prod }\limits_{i = 1}^G \frac{{{\mathrm{\Gamma }}(x_{ijl} + \alpha _{ilk})}}{{{\mathrm{\Gamma }}(\alpha _{ilk})}}} \right)\frac{{{\mathrm{\Gamma }}(|{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}|)}}{{{\mathrm{\Gamma }}\left( {T_{jl} + \left| {{\boldsymbol{\alpha }}_{ \cdot \cdot {\boldsymbol{k}}}} \right|} \right)}}.$$\end{document}</tex-math><mml:math id="M68"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mi mathvariant="normal">&#x02223;</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>!</mml:mo></mml:mrow><mml:mrow><mml:msubsup><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>!</mml:mo></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x02211;</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mi>I</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mfenced close="&#x02223;" open="&#x02223;" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula></p><p id="Par34">We further assume that all <italic>C</italic><sub><italic>l</italic></sub> cells in individual <italic>l</italic> are independent, then the joint distribution for all cells in individual <italic>l</italic> is<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {{\boldsymbol{x}}_{ \cdot \cdot {\boldsymbol{l}}},{\boldsymbol{z}}_{ \cdot {\boldsymbol{l}}}|{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{l}} \cdot }} \right) = \mathop {\prod }\limits_{j = 1}^{C_l} P\left( {{\boldsymbol{x}}_{ \cdot {\boldsymbol{jl}}},z_{jl}{\mathrm{|}}{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{l}} \cdot }} \right).$$\end{document}</tex-math><mml:math id="M70"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munderover><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mi mathvariant="normal">&#x02223;</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula></p><p id="Par35">Finally, we assume that all <italic>L</italic> individuals are independent, then the overall joint distribution for all cells across all individuals becomes<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {{\boldsymbol{x}}_{ \cdot \cdot \cdot },{\boldsymbol{z}}_{ \cdot \cdot }|{\boldsymbol{\alpha }}_{ \cdot \cdot \cdot }} \right) = \mathop {\prod }\limits_{l = 1}^L P\left( {{\boldsymbol{x}}_{ \cdot \cdot {\boldsymbol{l}}},{\boldsymbol{z}}_{ \cdot {\boldsymbol{l}}}|{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{l}}\, \cdot }} \right) \\ \propto \mathop {\prod }\limits_{l = 1}^L \mathop {\prod }\limits_{j = 1}^{C_l} \left\{ {\mathop {\sum }\limits_{k = 1}^K I\left( {z_{jl} = k} \right)\left( {\mathop {\prod }\limits_{i = 1}^G \frac{{{\mathrm{\Gamma }}\left( {x_{ijl} + \alpha _{ilk}} \right)}}{{{\mathrm{\Gamma }}\left( {\alpha _{ilk}} \right)}}} \right)\frac{{{\mathrm{\Gamma }}\left( {\left| {{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}} \right|} \right)}}{{{\mathrm{\Gamma }}\left( {T_{jl} + \left| {{\boldsymbol{\alpha }}_{ \cdot {\boldsymbol{lk}}}} \right|} \right)}}} \right\}.$$\end{document}</tex-math><mml:math id="M72"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:munderover><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">l</mml:mi><mml:mspace width="0.3em"/><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>&#x0221d;</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:munderover><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munderover><mml:mfenced close="}" open="{" separators=""><mml:mrow><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x02211;</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mi>I</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:mfenced><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:mfenced close="&#x02223;" open="&#x02223;" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mfenced close="&#x02223;" open="&#x02223;" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula></p><p id="Par36">In this model, the two sets of parameters of interest are <inline-formula id="IEq32"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{z}}_{ \cdot \cdot } = \left\{ {z_{jl}} \right\}_{1 \le j \le C_l,1 \le l \le L}$$\end{document}</tex-math><mml:math id="M74"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mfenced close="}" open="{" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>j</mml:mi><mml:mo>&#x02264;</mml:mo><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>l</mml:mi><mml:mo>&#x02264;</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq32.gif"/></alternatives></inline-formula>, the cell type label for cell <italic>j</italic> in individual <italic>l</italic>, and <inline-formula id="IEq33"><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{\alpha }}_{ \cdot \cdot \cdot } = \left\{ {\alpha _{ilk}} \right\}_{1 \le i \le G,1 \le l \le L,1 \le k \le K}$$\end{document}</tex-math><mml:math id="M76"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mfenced close="}" open="{" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>i</mml:mi><mml:mo>&#x02264;</mml:mo><mml:mi>G</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>l</mml:mi><mml:mo>&#x02264;</mml:mo><mml:mi>L</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo>&#x02264;</mml:mo><mml:mi>k</mml:mi><mml:mo>&#x02264;</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq33.gif"/></alternatives></inline-formula>, the Dirichlet parameters for gene <italic>i</italic> in cell type <italic>k</italic> in individual <italic>l</italic>. We adopt a full Bayesian approach and use Gibbs sampler to estimate the posterior distributions. Specifically, the joint posterior distribution for <inline-formula id="IEq34"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{z}}_{ \cdot \cdot }$$\end{document}</tex-math><mml:math id="M78"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq34.gif"/></alternatives></inline-formula> and <inline-formula id="IEq35"><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{\alpha }}_{ \cdot \cdot \cdot }$$\end{document}</tex-math><mml:math id="M80"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq35.gif"/></alternatives></inline-formula> are<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {{\boldsymbol{z}}_{ \cdot \cdot },{\boldsymbol{\alpha }}_{ \cdot \cdot \cdot }|{\boldsymbol{x}}_{ \cdot \cdot \cdot }} \right) \propto P\left( {{\boldsymbol{x}}_{ \cdot \cdot \cdot },{\boldsymbol{z}}_{ \cdot \cdot }|{\boldsymbol{\alpha }}_{ \cdot \cdot \cdot }} \right) \times Prior\left( {{\boldsymbol{\alpha }}_{ \cdot \cdot \cdot }} \right).$$\end{document}</tex-math><mml:math id="M82"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>&#x0221d;</mml:mo><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>&#x000d7;</mml:mo><mml:mi>P</mml:mi><mml:mi>r</mml:mi><mml:mi>i</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula></p><p id="Par37">Since all <italic>&#x003b1;</italic>&#x02019;s are strictly positive, we propose a log-normal distribution as the prior distribution for <inline-formula id="IEq36"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{ilk}$$\end{document}</tex-math><mml:math id="M84"><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq36.gif"/></alternatives></inline-formula>. We assume that for gene <italic>i</italic> in cell type <italic>k</italic>, <inline-formula id="IEq37"><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{ilk}$$\end{document}</tex-math><mml:math id="M86"><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq37.gif"/></alternatives></inline-formula> from all <italic>L</italic> individuals share the same prior distribution LN <inline-formula id="IEq38"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(\mu _{ik},\sigma _{ik}^2)$$\end{document}</tex-math><mml:math id="M88"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq38.gif"/></alternatives></inline-formula>, that is<disp-formula id="Equ7"><label>7</label><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{Prior}}\left( {{\boldsymbol{\alpha }}_{{\boldsymbol{i}} \cdot {\boldsymbol{k}}}} \right) = \mathop {\prod }\limits_{l = 1}^L \frac{1}{{\alpha _{ilk}\sqrt {2\pi \sigma _{ik}^2} }}\exp \left\{ { - \frac{{\left( {\log \alpha _{ilk} - \mu _{ik}} \right)^2}}{{2\sigma _{ik}^2}}} \right\}.$$\end{document}</tex-math><mml:math id="M90"><mml:mi mathvariant="normal">Prior</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msqrt><mml:mn>2</mml:mn><mml:mi>&#x003c0;</mml:mi><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:msqrt></mml:mrow></mml:mfrac><mml:mo> exp</mml:mo><mml:mfenced close="}" open="{" separators=""><mml:mrow><mml:mo>-</mml:mo><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:mo>log</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ7.gif" position="anchor"/></alternatives></disp-formula>Here, <inline-formula id="IEq39"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{ik}$$\end{document}</tex-math><mml:math id="M92"><mml:msub><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq39.gif"/></alternatives></inline-formula> can be estimated by the mean of <inline-formula id="IEq40"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{ilk}$$\end{document}</tex-math><mml:math id="M94"><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq40.gif"/></alternatives></inline-formula>'s: <inline-formula id="IEq41"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat \mu _{ik} = \frac{1}{L}\mathop {\sum }\limits_{l = 1}^L {\mathrm{log}}(\alpha _{ilk})$$\end{document}</tex-math><mml:math id="M96"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x02211;</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:munderover><mml:mi mathvariant="normal">log</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq41.gif"/></alternatives></inline-formula>. Estimation of <inline-formula id="IEq42"><alternatives><tex-math id="M97">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{ik}^2$$\end{document}</tex-math><mml:math id="M98"><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq42.gif"/></alternatives></inline-formula> can be challenging due to limited number of individuals. We can assume all <inline-formula id="IEq43"><alternatives><tex-math id="M99">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma _{ik}^2$$\end{document}</tex-math><mml:math id="M100"><mml:msubsup><mml:mrow><mml:mi>&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq43.gif"/></alternatives></inline-formula>&#x02019;s follow a hyper-prior: Gamma distribution Gamma<inline-formula id="IEq44"><alternatives><tex-math id="M101">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(a_k,b_k)$$\end{document}</tex-math><mml:math id="M102"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq44.gif"/></alternatives></inline-formula>, and use information across all genes to estimate variance. In addition, we assume a noninformative prior for <inline-formula id="IEq45"><alternatives><tex-math id="M103">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{ik}$$\end{document}</tex-math><mml:math id="M104"><mml:msub><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq45.gif"/></alternatives></inline-formula>&#x02019;s. Taken all together, we have the full posterior distribution as follows:<disp-formula id="Equ8"><label>8</label><alternatives><tex-math id="M105">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {{\boldsymbol{z}}_{ \cdot \cdot },{\boldsymbol{\alpha }}_{ \cdot \cdot \cdot }|{\boldsymbol{x}}_{ \cdot \cdot \cdot }} \right) \propto P\left( {{\boldsymbol{x}}_{ \cdot \cdot \cdot },{\boldsymbol{z}}_{ \cdot \cdot }|{\boldsymbol{\alpha }}_{ \cdot \cdot \cdot }} \right) \times \mathop {\prod }\limits_{k = 1}^K \mathop {\prod }\limits_{i = 1}^G {\mathrm{prior}}\left( {{\boldsymbol{\alpha }}_{{\boldsymbol{i}} \cdot {\boldsymbol{k}}}} \right) \times \mathop {\prod }\limits_{k = 1}^K {\mathrm{prior}}\left( {{\boldsymbol{\mu }}_{ \cdot {\boldsymbol{k}}}} \right) \times \mathop {\prod }\limits_{k = 1}^K {\mathrm{prior}}\left( {{\boldsymbol{\sigma }}_{ \cdot {\boldsymbol{k}}}^2} \right).$$\end{document}</tex-math><mml:math id="M106"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>&#x0221d;</mml:mo><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>&#x000d7;</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo> &#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:munderover><mml:mi mathvariant="normal">prior</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>&#x000d7;</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mi mathvariant="normal">prior</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">&#x003bc;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>&#x000d7;</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mi mathvariant="normal">prior</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">&#x003c3;</mml:mi></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ8.gif" position="anchor"/></alternatives></disp-formula></p><p id="Par38">We use Gibbs sample to iteratively update <inline-formula id="IEq46"><alternatives><tex-math id="M107">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{ilk}$$\end{document}</tex-math><mml:math id="M108"><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq46.gif"/></alternatives></inline-formula> and <inline-formula id="IEq47"><alternatives><tex-math id="M109">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{jl}$$\end{document}</tex-math><mml:math id="M110"><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq47.gif"/></alternatives></inline-formula>. Details can be found in Supplementary&#x000a0;<xref rid="MOESM1" ref-type="media">Methods</xref>.</p></sec><sec id="Sec13"><title>Classification and computational acceleration</title><p id="Par39">To further improve the computational efficiency, we provide a supervised option in BAMM-SC. Specifically, for very large-scale dataset, we use BAMM-SC to train a prediction model using a subset of cells from each individual and predict the clustering labels for the rest of cells. First, we randomly select a subset of cells from each individual and applied BAMM-SC on these selected cells. The estimate of <inline-formula id="IEq48"><alternatives><tex-math id="M111">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{ilk}$$\end{document}</tex-math><mml:math id="M112"><mml:msub><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq48.gif"/></alternatives></inline-formula> is computed as the average after deletion of the first 100 (default) iterations as burn-in. We then predict the cell type labels for other cells with realization of parameters: <inline-formula id="IEq49"><alternatives><tex-math id="M113">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat \Theta = \left( {{\hat{\boldsymbol{\alpha }}}_{ \cdot 1 \cdot }, \ldots ,{\hat{\boldsymbol{\alpha }}}_{ \cdot {\boldsymbol{L}} \cdot },{\hat{\boldsymbol{\pi }}}_1, \ldots ,{\hat{\boldsymbol{\pi }}}_{\boldsymbol{L}}} \right)$$\end{document}</tex-math><mml:math id="M114"><mml:mover accent="true"><mml:mrow><mml:mi>&#x00398;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover><mml:mo>=</mml:mo><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mn>1</mml:mn><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>&#x02026;</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">L</mml:mi><mml:mo>&#x022c5;</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003c0;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>&#x02026;</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003c0;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">L</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math><inline-graphic xlink:href="41467_2019_9639_Article_IEq49.gif"/></alternatives></inline-formula>.<disp-formula id="Equ9"><label>9</label><alternatives><tex-math id="M115">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\left( {z_{jl} = k{\mathrm{|}}{\boldsymbol{x}}_{{\boldsymbol{jl}}},\hat \Theta } \right) = \frac{{\left( {\mathop {\prod }\nolimits_{i = 1}^G \frac{{{\mathrm{\Gamma }}\left( {x_{ijl} + \hat \alpha _{ilk}} \right)}}{{{\mathrm{\Gamma }}\left( {\hat \alpha _{ilk}} \right)}}} \right)\frac{{{\mathrm{\Gamma }}\left( {|{\hat{\boldsymbol{\alpha }}}_{ \cdot {\boldsymbol{lk}}}|} \right)}}{{{\mathrm{\Gamma }}\left( {T_j + |{\hat{\boldsymbol{\alpha }}}_{ \cdot {\boldsymbol{lk}}}|} \right)}}\hat \pi _{lk}}}{{\mathop {\sum }\nolimits_{k = 1}^K \left( {\mathop {\prod }\nolimits_{i = 1}^G \frac{{{\mathrm{\Gamma }}\left( {x_{ij} + \hat \alpha _{ilk}} \right)}}{{{\mathrm{\Gamma }}\left( {\hat \alpha _{ilk}} \right)}}} \right)\frac{{{\mathrm{\Gamma }}\left( {|{\hat{\boldsymbol{\alpha }}}_{ \cdot {\boldsymbol{lk}}}|} \right)}}{{{\mathrm{\Gamma }}\left( {T_j + |{\hat{\boldsymbol{\alpha }}}_{ \cdot {\boldsymbol{lk}}}|} \right)}}\hat \pi _{lk}}}.$$\end{document}</tex-math><mml:math id="M116"><mml:mi>P</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>k</mml:mi><mml:mi mathvariant="normal">&#x02223;</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">jl</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>&#x00398;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msubsup><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:msubsup><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>&#x003c0;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mrow><mml:mo>&#x02211;</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:msubsup><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msubsup><mml:mrow><mml:mo>&#x0220f;</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>G</mml:mi></mml:mrow></mml:msubsup><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi mathvariant="normal">&#x00393;</mml:mi><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mo>&#x02223;</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">&#x003b1;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>&#x022c5;</mml:mo><mml:mi mathvariant="bold-italic">lk</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02223;</mml:mo></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>&#x003c0;</mml:mi></mml:mrow><mml:mo>&#x0005e;</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:math><graphic xlink:href="41467_2019_9639_Article_Equ9.gif" position="anchor"/></alternatives></disp-formula></p><p id="Par40">This approach can substantially reduce the computational cost for very large-scale datasets while maintaining the accuracy as shown in Supplementary Fig.&#x000a0;<xref rid="MOESM1" ref-type="media">14</xref>.</p></sec><sec id="Sec14"><title>Single-cell sequencing library construction</title><p id="Par41">10&#x000d7; Genomics Chromium system, which is a microfluidics platform based on Gel bead in EMulsion (GEM) technology, was used for generating real test datasets. Cells mixed with reverse transcription reagents were loaded into the Chromium instrument. This instrument separated cells into minireaction partitions formed by oil microdroplets, each containing a gel bead and a cell, known as GEMs. GEMs contain a gel bead, scaffold for an oligonucleotide that is composed of an oligo-dT section for priming reverse transcription, and barcodes for each cell and each transcript as described. GEM generation takes place in a multiple-channel microfluidic chip that encapsulates single-gel beads. Reverse transcription takes place inside each droplet. Approximately, 1000-fold excess of partitions compared to cells ensured low capture of duplicate cells. The reaction mixture/emulsion was removed from the Chromium instrument, and reverse transcription was performed. The emulsion was then broken using a recovery agent, and following Dynabead and SPRI clean up cDNAs were amplified by PCR (C1000, Bio-Rad). cDNAs were sheared (Covaris) into ~200&#x02009;bp length. DNA fragment ends were repaired, A-tailed and adapters ligated. The library was quantified using KAPA Universal Library Quantification Kit KK4824 and further characterized for cDNA length on a Bioanalyzer using a High Sensitivity DNA kit. All sequencing experiments were conducted using Illumina NextSeq 500 in the Genomics Sequencing Core at the University of Pittsburgh.</p></sec><sec id="Sec15"><title>Data description</title><p id="Par42">Human PBMC dataset: Under a protocol approved by the University of Pittsburgh Institutional Review Board, peripheral blood was obtained from healthy donors by venipuncture. Each subject gave written informed consent. PBMC were isolated from whole blood by density gradient centrifugation using Ficoll&#x02013;Hypaque. PBMC were then counted and resuspended in phosphate buffered saline with 0.04% bovinue serum albumin, and were processed through the Chromium 10&#x000d7; Controller according to the manufacturers&#x02019; instructions, targeting a recovery of ~2000 cells. The following steps were all performed under the aforementioned protocol developed by 10&#x000d7; Genomics.</p><p id="Par43">Human skin dataset: Skin samples were obtained by performing 3&#x02009;mm punch biopsies from the dorsal midforearm of healthy control subjects after informed consent under a protocol approved by the University of Pittsburgh Institutional Review Board. Skin for scRNA-seq was digested enzymatically (Miltenyi Biotec Whole Skin Dissociation Kit, human) for 2&#x02009;h and further dispersed using the Miltenyi gentleMACS Octo Dissociator. The resulting cell suspension was filtered through 70 micron cell strainers twice and re-suspended in phosphate-buffered saline containing 0.04% bovine serum albumin. Cells from biopsies were mixed with reverse transcription reagents then loaded into the Chromium instrument (10&#x000d7; Genomics). Totally, ~2600&#x02013;4300 cells were loaded into the instrument to obtain data on ~1100&#x02013;1800 cells, anticipating a multiplet rate of ~1.2% of partitions. The following steps were all performed under the aforementioned protocol developed by 10&#x000d7; Genomics.</p><p id="Par44">Mouse lung dataset: Lung single cell suspension from na&#x000ef;ve and infected C57BL/6 mice were subject to scRNA-seq library preparation protocol. Briefly, left lobs of both na&#x000ef;ve and infected mice were removed and digested by Collagenase/DNase to obtain single-cell suspension. Mononuclear cells after filtration with a 40&#x02009;&#x003bc;M cell strainer were separated into minireaction partitions or GEMs formed by oil microdroplets, each containing a gel bead and a cell, by the Chromium instrument (10&#x000d7; Genomics). The reaction mixture/emulsion with captured and barcoded mRNAs were removed from the Chromium instrument followed by reverse transcription. The cDNA samples were fragmented and amplified using the Nextera XT kit (Illumina). The following steps were all performed under aforementioned the protocol developed by 10&#x000d7; Genomics. We have complied with all relevant ethical regulations for animal research. The animal protocol was approved by the University of Pittsburgh Institutional Animal Care and Use Committee.</p></sec><sec id="Sec16"><title>Reporting summary</title><p id="Par45">Further information on experimental design is available in the&#x000a0;<xref rid="MOESM2" ref-type="media">Nature Research Reporting Summary</xref> linked to this article.</p></sec></sec><sec sec-type="supplementary-material"><title>Supplementary information</title><sec id="Sec17"><p>
<supplementary-material content-type="local-data" id="MOESM1"><media xlink:href="41467_2019_9639_MOESM1_ESM.pdf"><caption><p>Supplementary Information</p></caption></media></supplementary-material>
<supplementary-material content-type="local-data" id="MOESM2"><media xlink:href="41467_2019_9639_MOESM2_ESM.pdf"><caption><p>Reporting Summary</p></caption></media></supplementary-material>
</p></sec></sec></body><back><fn-group><fn><p><bold>Journal peer review information:</bold>
<italic>Nature Communications</italic> thanks the anonymous reviewer(s) for their contribution to the peer review of this work.</p></fn><fn><p><bold>Publisher&#x02019;s note:</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p></fn><fn><p>These authors contributed equally: Zhe Sun, Li Chen.</p></fn></fn-group><sec><title>Supplementary information</title><p><bold>Supplementary Information</bold> accompanies this paper at 10.1038/s41467-019-09639-3.</p></sec><ack><title>Acknowledgements</title><p>This work is supported by National Institute of Health grants R56HL137709 (K.C.), P50 CA097190 and P30 CA047904 (D.A.A.V.), P50 AR060780 (R.L. and W.C.), R35HL139930 (J.K.), and Children&#x02019;s Hospital of Pittsburgh (W.C. and Z.S.).</p></ack><notes notes-type="author-contribution"><title>Author contributions</title><p>M.H. and W.C. conceived the study; Z.S. led the statistical modeling and data analysis; L.C. helped with developing the R package; A.R.C., T.C.B., and D.A.A.V. performed the experiments for the human PBMC data; T.T. and R.L. performed the experiments for the human skin data; K.C. and J.K.K. performed the experiments for the mouse data; H.X., Y.J., and Q.H. helped with the preprocessing and analyzing the data; Y.D., W.C., and M.H. supervised the research; and Z.S., W.C., Y.D., and M.H. led the writing of the paper with input from all the other authors.</p></notes><notes notes-type="data-availability"><title>Data availability</title><p>The study uses various publicly available scRNA-seq datasets. Both human PBMC (sample 5) and purified CD19+B cell scRNA-seq data that support the findings of this study are available at <ext-link ext-link-type="uri" xlink:href="https://support.10xgenomics.com/single-cell-gene-expression/datasets">https://support.10xgenomics.com/single-cell-gene-expression/datasets</ext-link>. The raw fastq files and preprocessed experimental test datasets (human PBMCs, mouse lung and human skin tissues) have been deposited in the gene expression omnibus (GEO) database under accession number GSE128066. All other relevant data are available upon request.</p></notes><notes notes-type="data-availability"><title>Code availability</title><p>BAMM-SC, including all source and example code, is freely available as an R package with a detailed tutorial at <ext-link ext-link-type="uri" xlink:href="https://github.com/CHPGenetics/BAMMSC">https://github.com/CHPGenetics/BAMMSC</ext-link>.</p></notes><notes notes-type="COI-statement"><sec id="FPar1"><title>Competing interests</title><p>The authors declare no competing interests.</p></sec></notes><ref-list id="Bib1"><title>References</title><ref id="CR1"><label>1.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gawad</surname><given-names>C</given-names></name><name><surname>Koh</surname><given-names>W</given-names></name><name><surname>Quake</surname><given-names>SR</given-names></name></person-group><article-title>Single-cell genome sequencing: current state of the science</article-title><source>Nat. Rev. Genet.</source><year>2016</year><volume>17</volume><fpage>175</fpage><lpage>188</lpage><pub-id pub-id-type="doi">10.1038/nrg.2015.16</pub-id><pub-id pub-id-type="pmid">26806412</pub-id></element-citation></ref><ref id="CR2"><label>2.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tang</surname><given-names>F</given-names></name><etal/></person-group><article-title>mRNA-Seq whole-transcriptome analysis of a single cell</article-title><source>Nat. Methods</source><year>2009</year><volume>6</volume><fpage>377</fpage><lpage>382</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1315</pub-id><pub-id pub-id-type="pmid">19349980</pub-id></element-citation></ref><ref id="CR3"><label>3.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Macosko</surname><given-names>EZ</given-names></name><etal/></person-group><article-title>Highly parallel genome-wide expression profiling of individual cells using nanoliter droplets</article-title><source>Cell</source><year>2015</year><volume>161</volume><fpage>1202</fpage><lpage>1214</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2015.05.002</pub-id><pub-id pub-id-type="pmid">26000488</pub-id></element-citation></ref><ref id="CR4"><label>4.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zheng</surname><given-names>GX</given-names></name><etal/></person-group><article-title>Massively parallel digital transcriptional profiling of single cells</article-title><source>Nat. Commun.</source><year>2017</year><volume>8</volume><fpage>14049</fpage><pub-id pub-id-type="doi">10.1038/ncomms14049</pub-id><pub-id pub-id-type="pmid">28091601</pub-id></element-citation></ref><ref id="CR5"><label>5.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jaitin</surname><given-names>DA</given-names></name><etal/></person-group><article-title>Massively parallel single-cell RNA-seq for marker-free decomposition of tissues into cell types</article-title><source>Science</source><year>2014</year><volume>343</volume><fpage>776</fpage><lpage>779</lpage><pub-id pub-id-type="doi">10.1126/science.1247651</pub-id><pub-id pub-id-type="pmid">24531970</pub-id></element-citation></ref><ref id="CR6"><label>6.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pollen</surname><given-names>AA</given-names></name><etal/></person-group><article-title>Low-coverage single-cell mRNA sequencing reveals cellular heterogeneity and activated signaling pathways in developing cerebral cortex</article-title><source>Nat. Biotechnol.</source><year>2014</year><volume>32</volume><fpage>1053</fpage><lpage>1058</lpage><pub-id pub-id-type="doi">10.1038/nbt.2967</pub-id><pub-id pub-id-type="pmid">25086649</pub-id></element-citation></ref><ref id="CR7"><label>7.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>van der Wijst</surname><given-names>MGP</given-names></name><etal/></person-group><article-title>Single-cell RNA sequencing identifies celltype-specific cis-eQTLs and co-expression QTLs</article-title><source>Nat. Genet.</source><year>2018</year><volume>50</volume><fpage>493</fpage><lpage>497</lpage><pub-id pub-id-type="doi">10.1038/s41588-018-0089-9</pub-id><pub-id pub-id-type="pmid">29610479</pub-id></element-citation></ref><ref id="CR8"><label>8.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rodriguez</surname><given-names>A</given-names></name><name><surname>Laio</surname><given-names>A</given-names></name></person-group><article-title>Machine learning. <italic>Clustering by fast search and find of density peaks</italic></article-title><source>Science</source><year>2014</year><volume>344</volume><fpage>1492</fpage><lpage>1496</lpage><pub-id pub-id-type="doi">10.1126/science.1242072</pub-id><pub-id pub-id-type="pmid">24970081</pub-id></element-citation></ref><ref id="CR9"><label>9.</label><mixed-citation publication-type="other">Wang, B. et al. SIMLR: a tool for large-scale genomic analyses by multi-kernel learning. <italic>Proteomics</italic><bold>18</bold> 1700232 (2018).</mixed-citation></ref><ref id="CR10"><label>10.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>duVerle</surname><given-names>DA</given-names></name><name><surname>Yotsukura</surname><given-names>S</given-names></name><name><surname>Nomura</surname><given-names>S</given-names></name><name><surname>Aburatani</surname><given-names>H</given-names></name><name><surname>Tsuda</surname><given-names>K</given-names></name></person-group><article-title>CellTree: an R/bioconductor package to infer the hierarchical structure of cell populations from single-cell RNA-seq data</article-title><source>BMC Bioinformatics</source><year>2016</year><volume>17</volume><fpage>363</fpage><pub-id pub-id-type="doi">10.1186/s12859-016-1175-6</pub-id><pub-id pub-id-type="pmid">27620863</pub-id></element-citation></ref><ref id="CR11"><label>11.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kiselev</surname><given-names>VY</given-names></name><etal/></person-group><article-title>SC3: consensus clustering of single-cell RNA-seq data</article-title><source>Nat. Methods</source><year>2017</year><volume>14</volume><fpage>483</fpage><lpage>486</lpage><pub-id pub-id-type="doi">10.1038/nmeth.4236</pub-id><pub-id pub-id-type="pmid">28346451</pub-id></element-citation></ref><ref id="CR12"><label>12.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ji</surname><given-names>Z</given-names></name><name><surname>Ji</surname><given-names>H</given-names></name></person-group><article-title>TSCAN: pseudo-time reconstruction and evaluation in single-cell RNA-seq analysis</article-title><source>Nucleic Acids Res.</source><year>2016</year><volume>44</volume><fpage>e117</fpage><pub-id pub-id-type="doi">10.1093/nar/gkw430</pub-id><pub-id pub-id-type="pmid">27179027</pub-id></element-citation></ref><ref id="CR13"><label>13.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sun</surname><given-names>Z</given-names></name><etal/></person-group><article-title>DIMM-SC: a Dirichlet mixture model for clustering droplet-based single cell transcriptomic data</article-title><source>Bioinformatics</source><year>2018</year><volume>34</volume><fpage>139</fpage><lpage>146</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btx490</pub-id><pub-id pub-id-type="pmid">29036318</pub-id></element-citation></ref><ref id="CR14"><label>14.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Crow</surname><given-names>M</given-names></name><name><surname>Paul</surname><given-names>A</given-names></name><name><surname>Ballouz</surname><given-names>S</given-names></name><name><surname>Huang</surname><given-names>ZJ</given-names></name><name><surname>Gillis</surname><given-names>J</given-names></name></person-group><article-title>Characterizing the replicability of cell types defined by single cell RNA-sequencing data using MetaNeighbor</article-title><source>Nat. Commun.</source><year>2018</year><volume>9</volume><fpage>884</fpage><pub-id pub-id-type="doi">10.1038/s41467-018-03282-0</pub-id><pub-id pub-id-type="pmid">29491377</pub-id></element-citation></ref><ref id="CR15"><label>15.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Spitzer</surname><given-names>MH</given-names></name><etal/></person-group><article-title>IMMUNOLOGY. An interactive reference framework for modeling a dynamic immune system</article-title><source>Science</source><year>2015</year><volume>349</volume><fpage>1259425</fpage><pub-id pub-id-type="doi">10.1126/science.1259425</pub-id><pub-id pub-id-type="pmid">26160952</pub-id></element-citation></ref><ref id="CR16"><label>16.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Haghverdi</surname><given-names>L</given-names></name><name><surname>Lun</surname><given-names>ATL</given-names></name><name><surname>Morgan</surname><given-names>MD</given-names></name><name><surname>Marioni</surname><given-names>JC</given-names></name></person-group><article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title><source>Nat. Biotechnol.</source><year>2018</year><volume>36</volume><fpage>421</fpage><lpage>427</lpage><pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id><pub-id pub-id-type="pmid">29608177</pub-id></element-citation></ref><ref id="CR17"><label>17.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Satija</surname><given-names>R</given-names></name><name><surname>Farrell</surname><given-names>JA</given-names></name><name><surname>Gennert</surname><given-names>D</given-names></name><name><surname>Schier</surname><given-names>AF</given-names></name><name><surname>Regev</surname><given-names>A</given-names></name></person-group><article-title>Spatial reconstruction of single-cell gene expression data</article-title><source>Nat. Biotechnol.</source><year>2015</year><volume>33</volume><fpage>495</fpage><lpage>502</lpage><pub-id pub-id-type="doi">10.1038/nbt.3192</pub-id><pub-id pub-id-type="pmid">25867923</pub-id></element-citation></ref><ref id="CR18"><label>18.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rand</surname><given-names>WM</given-names></name></person-group><article-title>Objective criteria for the evaluation of clustering methods</article-title><source>J. Am. Stat. Assoc.</source><year>1971</year><volume>66</volume><fpage>846</fpage><lpage>850</lpage><pub-id pub-id-type="doi">10.1080/01621459.1971.10482356</pub-id></element-citation></ref><ref id="CR19"><label>19.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Freytag</surname><given-names>S</given-names></name><name><surname>Tian</surname><given-names>L</given-names></name><name><surname>Lonnstedt</surname><given-names>I</given-names></name><name><surname>Ng</surname><given-names>M</given-names></name><name><surname>Bahlo</surname><given-names>M</given-names></name></person-group><article-title>Comparison of clustering tools in R for medium-sized 10x Genomics single-cell RNA-sequencing data</article-title><source>F1000Res.</source><year>2018</year><volume>7</volume><fpage>1297</fpage><pub-id pub-id-type="doi">10.12688/f1000research.15809.1</pub-id><pub-id pub-id-type="pmid">30228881</pub-id></element-citation></ref><ref id="CR20"><label>20.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Duo</surname><given-names>A</given-names></name><name><surname>Robinson</surname><given-names>MD</given-names></name><name><surname>Soneson</surname><given-names>C</given-names></name></person-group><article-title>A systematic performance evaluation of clustering methods for single-cell RNA-seq data</article-title><source>F1000Res.</source><year>2018</year><volume>7</volume><fpage>1141</fpage><pub-id pub-id-type="doi">10.12688/f1000research.15666.1</pub-id><pub-id pub-id-type="pmid">30271584</pub-id></element-citation></ref><ref id="CR21"><label>21.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zappia</surname><given-names>L</given-names></name><name><surname>Phipson</surname><given-names>B</given-names></name><name><surname>Oshlack</surname><given-names>A</given-names></name></person-group><article-title>Splatter: simulation of single-cell RNA sequencing data</article-title><source>Genome. Biol.</source><year>2017</year><volume>18</volume><fpage>174</fpage><pub-id pub-id-type="doi">10.1186/s13059-017-1305-0</pub-id><pub-id pub-id-type="pmid">28899397</pub-id></element-citation></ref><ref id="CR22"><label>22.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>K</given-names></name><name><surname>Kolls</surname><given-names>JK</given-names></name></person-group><article-title>T cell-mediated host immune defenses in the lung</article-title><source>Annu. Rev. Immunol.</source><year>2013</year><volume>31</volume><fpage>605</fpage><lpage>633</lpage><pub-id pub-id-type="doi">10.1146/annurev-immunol-032712-100019</pub-id><pub-id pub-id-type="pmid">23516986</pub-id></element-citation></ref><ref id="CR23"><label>23.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Weiser</surname><given-names>JN</given-names></name></person-group><article-title>The pneumococcus: why a commensal misbehaves</article-title><source>J. Mol. Med.</source><year>2010</year><volume>88</volume><fpage>97</fpage><lpage>102</lpage><pub-id pub-id-type="doi">10.1007/s00109-009-0557-x</pub-id><pub-id pub-id-type="pmid">19898768</pub-id></element-citation></ref><ref id="CR24"><label>24.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tabib</surname><given-names>T</given-names></name><name><surname>Morse</surname><given-names>C</given-names></name><name><surname>Wang</surname><given-names>T</given-names></name><name><surname>Chen</surname><given-names>W</given-names></name><name><surname>Lafyatis</surname><given-names>R</given-names></name></person-group><article-title>SFRP2/DPP4 and FMO1/LSP1 define major fibroblast populations in human skin.</article-title><source>J. Invest. Dermatol.</source><year>2018</year><volume>138</volume><fpage>802</fpage><lpage>810</lpage><pub-id pub-id-type="doi">10.1016/j.jid.2017.09.045</pub-id><pub-id pub-id-type="pmid">29080679</pub-id></element-citation></ref><ref id="CR25"><label>25.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Datta</surname><given-names>S</given-names></name><name><surname>Datta</surname><given-names>S</given-names></name></person-group><article-title>Comparisons and validation of statistical clustering techniques for microarray gene expression data</article-title><source>Bioinformatics</source><year>2003</year><volume>19</volume><fpage>459</fpage><lpage>466</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btg025</pub-id><pub-id pub-id-type="pmid">12611800</pub-id></element-citation></ref><ref id="CR26"><label>26.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rousseeuw</surname><given-names>PJ</given-names></name></person-group><article-title>Silhouettes: a graphical aid to the interpretation and validation of cluster analysis</article-title><source>J. Comput. Appl. Math.</source><year>1987</year><volume>20</volume><fpage>53</fpage><lpage>65</lpage><pub-id pub-id-type="doi">10.1016/0377-0427(87)90125-7</pub-id></element-citation></ref><ref id="CR27"><label>27.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Coifman</surname><given-names>RR</given-names></name><etal/></person-group><article-title>Geometric diffusions as a tool for harmonic analysis and structure definition of data: diffusion maps</article-title><source>Proc. Natl Acad. Sci. USA</source><year>2005</year><volume>102</volume><fpage>7426</fpage><lpage>7431</lpage><pub-id pub-id-type="doi">10.1073/pnas.0500334102</pub-id><pub-id pub-id-type="pmid">15899970</pub-id></element-citation></ref><ref id="CR28"><label>28.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lopez</surname><given-names>R</given-names></name><name><surname>Regier</surname><given-names>J</given-names></name><name><surname>Cole</surname><given-names>MB</given-names></name><name><surname>Jordan</surname><given-names>MI</given-names></name><name><surname>Yosef</surname><given-names>N</given-names></name></person-group><article-title>Deep generative modeling for single-cell transcriptomics</article-title><source>Nat. Methods</source><year>2018</year><volume>15</volume><fpage>1053</fpage><pub-id pub-id-type="doi">10.1038/s41592-018-0229-2</pub-id><pub-id pub-id-type="pmid">30504886</pub-id></element-citation></ref><ref id="CR29"><label>29.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Trapnell</surname><given-names>C</given-names></name><etal/></person-group><article-title>The dynamics and regulators of cell fate decisions are revealed by pseudotemporal ordering of single cells</article-title><source>Nat. Biotechnol.</source><year>2014</year><volume>32</volume><fpage>381</fpage><lpage>386</lpage><pub-id pub-id-type="doi">10.1038/nbt.2859</pub-id><pub-id pub-id-type="pmid">24658644</pub-id></element-citation></ref><ref id="CR30"><label>30.</label><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Trapnell</surname><given-names>C</given-names></name></person-group><article-title>Defining cell types and states with single-cell genomics</article-title><source>Genome Res.</source><year>2015</year><volume>25</volume><fpage>1491</fpage><lpage>1498</lpage><pub-id pub-id-type="doi">10.1101/gr.190595.115</pub-id><pub-id pub-id-type="pmid">26430159</pub-id></element-citation></ref></ref-list></back></article>